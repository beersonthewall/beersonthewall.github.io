<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
  <title>Beersonthewall</title>

  
  <link rel="stylesheet" href="https://www.beersonthewall.com/css/style.css">
</head>


  <body>

    
<header id="header">
  <nav>
    <ul id="main">
      <li>
        <a href="https://www.beersonthewall.com/" >
          <h1>Beersonthewall</h1>
        </a>
      </li>
    </ul>

    <ul id="info">
      
      <li>
        
          <a href="/readinglist/">
        
          <img src="/images/book.svg" alt="reading list">
        </a>
      </li>
      
      <li>
        
          <a href="mailto:%20matthew@beersonthewall.com">
        
          <img src="/images/email.svg" alt="email">
        </a>
      </li>
      
      <li>
        
          <a href="https://github.com/beersonthewall">
        
          <img src="/images/github.svg" alt="Github icon link">
        </a>
      </li>
      
      <li>
        
          <a href="/about/">
        
          <img src="/images/info.svg" alt="info">
        </a>
      </li>
      
      <li>
        
          <a href="/blog/index.xml">
        
          <img src="/images/rss.svg" alt="rss feed">
        </a>
      </li>
      
    </ul>
  </nav>
</header>


    <div id="content">
      
<article class="blog-post">

  <h1 class="blog-title">
    Kernel Debug Log 1
  </h1>

  <div class="blog-date">
    February 28, 2022
  </div>

  <p class="blog-content">
    <p>Debug logs:</p>
<p>What follows is more-or-less stream of conciousness notes written while I was debugging my kernel code. I&rsquo;ve
found that writing my thought process down makes it easier to logically work through a problem. Additionally it&rsquo;s nice
to document how I&rsquo;ve solved problems.</p>
<p>The problem statement:</p>
<p>I&rsquo;m currently trying to implement recursive page tables in my <a href="https://github.com/beersonthewall/wizard_insane">x86_64 kernel project</a>.
I&rsquo;ve just gotten the map() function for the page mapper to stop faulting when mapping a
test page, now we&rsquo;re trying to make use of the newly mapped page:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust">
<span style="color:#66d9ef">pub</span> <span style="color:#66d9ef">fn</span> <span style="color:#a6e22e">init</span>(_multiboot_addr: <span style="color:#66d9ef">usize</span>) {
    <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> frame_allocator <span style="color:#f92672">=</span> FrameAllocator::new(PhysicalAddress::new(<span style="color:#ae81ff">10_000</span> <span style="color:#f92672">*</span> PAGE_SIZE));

    <span style="color:#66d9ef">let</span> <span style="color:#66d9ef">mut</span> page_mapper <span style="color:#f92672">=</span> PageMapper::init_kernel_table();

    <span style="color:#66d9ef">let</span> test_frame <span style="color:#f92672">=</span> Frame {
        frame_number: <span style="color:#ae81ff">0x55_55_BB_00_BB_BB_BB_BB</span> <span style="color:#f92672">/</span> PAGE_SIZE,
    };
    <span style="color:#66d9ef">let</span> test_page <span style="color:#f92672">=</span> Page::from_virtual_address(VirtualAddress::new(<span style="color:#ae81ff">0x0000_1FFF_0000_0000</span>));

    page_mapper.map(test_page, test_frame, <span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> frame_allocator);
    log<span style="color:#f92672">!</span>(<span style="color:#e6db74">&#34;Success!&#34;</span>);

    <span style="color:#66d9ef">let</span> test_value: <span style="color:#66d9ef">&amp;</span><span style="color:#a6e22e">mut</span> <span style="color:#66d9ef">u64</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">unsafe</span> { <span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> <span style="color:#f92672">*</span>(test_page.virtual_address().<span style="color:#ae81ff">0</span> <span style="color:#66d9ef">as</span> <span style="color:#f92672">*</span><span style="color:#66d9ef">mut</span> <span style="color:#66d9ef">u64</span>) };
    log<span style="color:#f92672">!</span>(<span style="color:#e6db74">&#34;test_value before: {test_value}&#34;</span>); <span style="color:#f92672">&lt;---</span> PROBLEMS BEGIN HERE
    <span style="color:#f92672">*</span>test_value <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span>;
    log<span style="color:#f92672">!</span>(<span style="color:#e6db74">&#34;test_value after: {test_value}&#34;</span>);

    log<span style="color:#f92672">!</span>(<span style="color:#e6db74">&#34;unmapping page&#34;</span>);
    page_mapper.unmap(test_page, test_frame, <span style="color:#f92672">&amp;</span><span style="color:#66d9ef">mut</span> frame_allocator);
}
</code></pre></div><p>When we try to access our new page we get the following error:</p>
<pre><code>[kernel] Hello world! :)
[kernel] Multiboot flags 4026597203
[kernel::memory::frame_alloc] start: 0x2710000
[kernel::memory::page_mapper] writing pml4 entry
[kernel::memory::page_mapper] new recursive page: ff7fbfc3f000
[kernel::memory::frame_alloc] allocating frame: 2710000
[kernel::memory::page_mapper] table vaddr: ffffff7fbfc3f000
[kernel::memory::page_mapper] writing pdpt entry
[kernel::memory::page_mapper] new recursive page: ff7f87ffc000
[kernel::memory::frame_alloc] allocating frame: 2711000
[kernel::memory::page_mapper] table vaddr: ffffff7f87ffc000
[kernel::memory::page_mapper] writing pd entry
[kernel::memory::page_mapper] new recursive page: ff0fff800000
[kernel::memory::frame_alloc] allocating frame: 2712000
[kernel::memory::page_mapper] table vaddr: ffffff0fff800000
[kernel::memory::page_mapper] writing pt entry
[kernel::memory] Success!
[kernel::memory] test_value before: check_exception old: 0xffffffff new 0xe
     0: v=0e e=0009 i=0 cpl=0 IP=0008:ffffffff801023c7 pc=ffffffff801023c7 SP=0010:ffffffff8010be00 CR2=00001fff00000000
RAX=0000000000000000 RBX=ffffffff8010c120 RCX=ffffffff8010c180 RDX=00000000000000e9
.
.
.
</code></pre><p>v=0e is vector 14, which according to the AMD64 system programming manual is a page
fault exception. The error code e=0009 has bits zero and three set which are page-protection
violation and reserved field violation respectively. We can also note that control register 2 (CR2)
contains the virtual address for test_page.</p>
<p>So the first guess is that we&rsquo;re not setting one of the table entries correctly when we map. We do have
page size extensions turned on (it&rsquo;s used to map our kernel pages in kernel/arch/amd64/start.S). However
the page mapper only supports 4KiB pages for now and we should be able to use both 2MiB and 4KiB pages,
as long as the page size bits are setup correctly. We&rsquo;ll also want to make sure we set the
User/Supervisor bit correctly (since that&rsquo;s the other error incidated in the fault).</p>
<p>Running qemu with <code>-s -S</code> will add a gdb stub and pause before starting. Which gives me time to
open gdb and run <code>target remote localhost:1234</code> so we can get a debugging session going.
Stepping through to just after map() returns, we can use the qemu monitoring
(ctrl-alt-2 in the qemu window) to get tlb information:</p>
<p><img src="/images/kernel-debug-log-01-tlb.png" alt="qemu info tlb output"></p>
<p>We can also check general memory information:</p>
<p><img src="/images/kernel-debug-log-01-mem.png" alt="qemu info mem output"></p>
<p>The error output also dumps control registers.</p>
<p><code>CR0=80010011 CR2=00001fff00000000 CR3=0000000000106000 CR4=000000b0</code></p>
<p>CR4 contains <code>0x000000b0</code>. 0xb0 sets bits 4, 5, and 7 for page size extension,
physical address extension, and page global enable
respectively.</p>
<p>We can also add some debug code to dump the state of relevant tables after we call map():</p>
<pre><code>[kernel::memory::page_mapper] pml4
[kernel::memory::page_mapper] entry 0: 107023
[kernel::memory::page_mapper] entry 63: 2710063
[kernel::memory::page_mapper] entry 510: 106063
[kernel::memory::page_mapper] entry 511: 108023
[kernel::memory::page_mapper] pdpt
[kernel::memory::page_mapper] entry 508: 2711063
[kernel::memory::page_mapper] pd
[kernel::memory::page_mapper] entry 0: 2712063
[kernel::memory::page_mapper] pt
[kernel::memory::page_mapper] entry 0: 5555bb00bbbbb003
</code></pre><p>Looking at the physical address, a few things might be wrong here:</p>
<p>First: it&rsquo;s got more that 52 bits of data (because we have PSE and PAE set as noted before),
so it&rsquo;s not really pointing where we think it is.</p>
<p>Second: that&rsquo;s probably way larger than the amount of &lsquo;physical&rsquo; memory qemu uses by default
which is 128 MiB. Ooops.</p>
<p>Let&rsquo;s change that to a more reasonable value: 0x4e20000 that fixes both problems.</p>
<p>Re-running gives a new error:</p>
<pre><code>[kernel] Hello world! :)
[kernel] Multiboot flags 4026597203
[kernel::memory::frame_alloc] start: 0x2710000
[kernel::memory::page_mapper] writing pml4 entry
[kernel::memory::page_mapper] new recursive page: ff7fbfc3f000
[kernel::memory::frame_alloc] allocating frame: 2710000
[kernel::memory::page_mapper] table vaddr: ffffff7fbfc3f000
[kernel::memory::page_mapper] writing pdpt entry
[kernel::memory::page_mapper] new recursive page: ff7f87ffc000
[kernel::memory::frame_alloc] allocating frame: 2711000
[kernel::memory::page_mapper] table vaddr: ffffff7f87ffc000
[kernel::memory::page_mapper] writing pd entry
[kernel::memory::page_mapper] new recursive page: ff0fff800000
[kernel::memory::frame_alloc] allocating frame: 2712000
[kernel::memory::page_mapper] table vaddr: ffffff0fff800000
[kernel::memory::page_mapper] writing pt entry
[kernel::memory::page_mapper] pml4
[kernel::memory::page_mapper] entry 0: 107023
[kernel::memory::page_mapper] entry 63: 2710063
[kernel::memory::page_mapper] entry 510: 106063
[kernel::memory::page_mapper] entry 511: 108023
[kernel::memory::page_mapper] pdpt
[kernel::memory::page_mapper] entry 508: 2711063
[kernel::memory::page_mapper] pd
[kernel::memory::page_mapper] entry 0: 2712063
[kernel::memory::page_mapper] pt
[kernel::memory::page_mapper] entry 0: 4e20003
[kernel::memory] Success!
[kernel::memory] test_value before: 0
[kernel::memory] test_value after: 100
[kernel::memory] unmapping page
[kernel::memory::page_mapper] new recursive page: ff7fbfc3f000
[kernel::memory::page_mapper] table vaddr: ffffff7fbfc3f000
[kernel::memory::page_mapper] new recursive page: ff7f87ffc000
[kernel::memory::page_mapper] table vaddr: ffffff7f87ffc000
[kernel::memory::page_mapper] new recursive page: ff0fff800000
[kernel::memory::page_mapper] table vaddr: ffffff0fff800000
[kernel::unwind] PANIC file='memory/page_mapper.rs', line=134 :: assertion failed: frame == pt_entry.frame()
</code></pre><p>but that&rsquo;s a problem for another debug log!</p>

  </p>

  <footer>
    
 


    <br>
  </footer>
</article>


    </div>

  </body>

</html>

